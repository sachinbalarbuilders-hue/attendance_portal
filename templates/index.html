<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Responsive viewport for all devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    {% if force_desktop_view %}
    <!-- Force desktop view - disable mobile features -->
    <meta name="mobile-web-app-capable" content="no">
    <meta name="apple-mobile-web-app-capable" content="no">
    <meta name="format-detection" content="telephone=no">
    <meta name="HandheldFriendly" content="false">
    <meta name="MobileOptimized" content="width">
    <meta name="theme-color" content="#667eea">
    {% else %}
    <!-- Normal mobile view -->
    <meta name="mobile-web-app-capable" content="no">
    <meta name="apple-mobile-web-app-capable" content="no">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#667eea">
    {% endif %}
    <!-- Prevent caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Employee Attendance Portal</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Professional attendance management system for employees">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Attendance Portal">
    <meta name="msapplication-TileColor" content="#764ba2">
    <meta name="msapplication-TileImage" content="{{ url_for('static', filename='icons/icon-144x144.png') }}">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-152x152.png') }}">
    <link rel="apple-touch-icon" sizes="152x152" href="{{ url_for('static', filename='icons/icon-152x152.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/icon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='icons/icon-72x72.png') }}">
    
    <!-- External Resources -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=100.0&t={{ range(100000, 999999) | random }}">
    
    {% if force_desktop_view %}
    <!-- Responsive design for all devices -->
    <style id="responsive-design">
        /* Responsive layout for all screen sizes */
        html, body, #app, #login-section, #dashboard-section { 
            width: 100% !important; 
            max-width: 100% !important; 
            min-width: 320px !important; 
            overflow-x: hidden !important;
            overflow-y: auto !important;
            box-sizing: border-box !important;
        }
        
        /* Responsive text sizing */
        *, *::before, *::after {
            -webkit-text-size-adjust: 100% !important;
            -moz-text-size-adjust: 100% !important;
            -ms-text-size-adjust: 100% !important;
            text-size-adjust: 100% !important;
        }
        
        /* Responsive login page */
        #login-section {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 320px !important;
            margin: 0 auto !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            padding: 2rem !important;
            box-sizing: border-box !important;
        }
        
        .login-container {
            width: 100% !important;
            max-width: 400px !important;
            min-width: 320px !important;
            box-sizing: border-box !important;
        }
    </style>
    {% endif %}
    
    <!-- Responsive initialization script -->
    <script>
        // Initialize responsive layout
        (function() {
            document.addEventListener('DOMContentLoaded', function() {
                // Ensure navbar is hidden on page load
                const navbar = document.getElementById('main-navbar');
                if (navbar) {
                    navbar.style.display = 'none';
                }
                
                // Load saved credentials if available
                if (typeof loadSavedCredentials === 'function') {
                    loadSavedCredentials();
                }
                
                // Auto-focus on email input
                if (typeof autoFocusEmailInput === 'function') {
                    autoFocusEmailInput();
                }
            });
        })();
    </script>
</head>
<body class="responsive-layout{% if force_desktop_view %} server-mobile-detected{% endif %}">
    <div id="app">
        <!-- Login Section -->
        <div id="login-section" class="main-header">
            <div class="login-container">
                <h1><i class="fas fa-building"></i> Employee Attendance Portal</h1>
                <p>Professional attendance management system</p>
                
                <!-- Maintenance Status Indicator -->
                <div id="maintenance-status" class="maintenance-status-indicator" style="display: none;">
                    <i class="fas fa-tools"></i>
                    <span>System maintenance in progress...</span>
                </div>
                
                <div id="login-form" class="login-form">
                    <div class="input-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="email" placeholder="Email Address" required>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" placeholder="Password" required>
                    </div>
                    
                    <!-- Remember Me Checkbox -->
                    <div class="remember-me-group">
                        <label class="remember-me-label">
                            <input type="checkbox" id="remember-me" class="remember-me-checkbox">
                            <span class="checkmark"></span>
                            <span class="remember-text">Remember me</span>
                        </label>
                        <button type="button" id="clear-saved-credentials" class="clear-credentials-btn" title="Clear saved credentials">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div class="security-notice">
                        <small><i class="fas fa-shield-alt"></i> Credentials are stored locally on this device only</small>
                    </div>
                    
                    <div class="button-group">
                        <button onclick="login()" class="btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </div>
                    
                </div>

            </div>
        </div>

        <!-- Navbar - Always present but hidden initially -->
        <nav id="main-navbar" class="navbar" role="navigation" aria-label="Main navigation" style="display: none;">
            <div class="nav-brand">
                <i class="fas fa-building" aria-hidden="true"></i> 
                <span>Employee Portal</span>
            </div>
            <div class="nav-user">
                <span id="user-info" class="user-info">
                    <i class="fas fa-user" aria-hidden="true"></i> 
                    <span id="user-name"></span>
                </span>
                <button id="logs-btn" onclick="showLogs()" class="btn-logs" style="display: none;" 
                        aria-label="View system logs" title="View system logs">
                    <i class="fas fa-list-alt" aria-hidden="true"></i> 
                    <span>Logs</span>
                </button>
                <button onclick="logout()" class="btn-logout" 
                        aria-label="Logout from system" title="Logout">
                    <i class="fas fa-sign-out-alt" aria-hidden="true"></i> 
                    <span>Logout</span>
                </button>
            </div>
        </nav>

        <!-- Dashboard Section -->
        <div id="dashboard-section" style="display: none;">

            <main class="dashboard">
                <!-- Admin Panel -->
                <div id="admin-panel" style="display: none;">
                    <div class="dashboard-header">
                        <div class="header-content">
                            <div class="header-text">
                                <h1><i class="fas fa-tools"></i> Admin Dashboard</h1>
                                <p>Complete System Management</p>
                            </div>
                            <div class="zoom-controls">
                                <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">
                                    <i class="fas fa-search-minus"></i>
                                </button>
                                <span class="zoom-level" id="zoom-level">100%</span>
                                <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                                <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom">
                                    <i class="fas fa-undo"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Maintenance Control -->
                    <div class="maintenance-control-section">
                        <h3><i class="fas fa-wrench"></i> System Maintenance</h3>
                        <div class="maintenance-control-content">
                            <p>Control maintenance mode for system updates</p>
                            <div class="maintenance-buttons">
                                <a href="/admin/maintenance" class="maintenance-link" target="_blank">
                                    <i class="fas fa-cog"></i> Open Maintenance Control
                                </a>
                                <button onclick="clearBrowserCache()" class="clear-cache-btn">
                                    <i class="fas fa-trash-alt"></i> Clear Cache
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="control-panel">
                        <div class="upload-section">
                            <h3><i class="fas fa-upload"></i> Upload Attendance Files</h3>
                            <div class="file-upload-area" onclick="document.getElementById('file-upload').click()">
                                <input type="file" id="file-upload" accept=".xlsx" multiple onchange="uploadFile()" style="display: none;">
                                <div class="upload-content">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p>Click to upload one or more Excel files or drag and drop</p>
                                    <small>Supported format: .xlsx | Multiple files allowed</small>
                                </div>
                            </div>
                        </div>

                        <div class="date-picker-section">
                            <h3><i class="fas fa-calendar"></i> Select Date Range</h3>
                            <div class="date-picker-wrapper">
                                <input type="date" id="date-picker" onchange="updateDateRange()" placeholder="Select a date...">
                            </div>
                            
                            <!-- Quick Date Selection Buttons -->
                            <div class="quick-date-buttons">
                                <button class="quick-date-btn" onclick="setQuickDate('today')">Today</button>
                                <button class="quick-date-btn" onclick="setQuickDate('yesterday')">Yesterday</button>
                                <button class="quick-date-btn" onclick="setQuickDate('week-ago')">1 Week Ago</button>
                                <button class="quick-date-btn" onclick="setQuickDate('month-ago')">1 Month Ago</button>
                                <button class="quick-date-btn" onclick="setQuickDate('clear')">Clear</button>
                            </div>
                        </div>
                    </div>


                    <!-- Employee Profile Card -->
                    <div id="employee-profile" class="employee-profile">
                        <h3><i class="fas fa-user-circle"></i> <span id="profile-employee-name"></span> - Detailed View</h3>
                        <div class="employee-profile-stats">
                            <div class="employee-profile-stat">
                                <h4 id="profile-total-days">0</h4>
                                <p>Working Days</p>
                            </div>
                            <div class="employee-profile-stat">
                                <h4 id="profile-present-days">0</h4>
                                <p>Present Days</p>
                            </div>
                            <div class="employee-profile-stat">
                                <h4 id="profile-leave-days">0</h4>
                                <p>Paid Days</p>
                            </div>
                            <div class="employee-profile-stat">
                                <h4 id="profile-unpaid-days">0</h4>
                                <p>Unpaid Days</p>
                            </div>
                            <div class="employee-profile-stat">
                                <h4 id="profile-attendance-rate">0%</h4>
                                <p>Attendance Rate</p>
                            </div>
                            <div class="employee-profile-stat">
                                <h4 id="profile-payable-days">0</h4>
                                <p>Payable Days</p>
                            </div>
                        </div>
                    </div>

                    <div class="stats-section">
                        <div class="stat-card">
                            <i class="fas fa-users"></i>
                            <div class="stat-content">
                                <h3 id="total-employees">0</h3>
                                <p>Total Employees</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-file-alt"></i>
                            <div class="stat-content">
                                <h3 id="total-records">0</h3>
                                <p>Total Records</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-calendar-check"></i>
                            <div class="stat-content">
                                <h3 id="data-until">--</h3>
                                <p>Data Until</p>
                            </div>
                        </div>
                    </div>

                    <div class="filters-section">
                        <!-- Employee Search -->
                        <div class="search-group">
                            <i class="fas fa-search"></i>
                            <input 
                                type="text" 
                                id="employee-search" 
                                placeholder="Search employee by name..." 
                                oninput="searchEmployees()"
                                autocomplete="off"
                            >
                            <button class="clear-search-btn" onclick="clearEmployeeSearch()" title="Clear search">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <select id="status-filter" onchange="applyFilters()">
                            <option value="All">All Statuses</option>
                            <option value="P">Present</option>
                            <option value="A">Absent</option>
                            <option value="W/O">Week Off</option>
                            <option value="PL">Paid Leave</option>
                            <option value="SL">Sick Leave</option>
                            <option value="FL">Festival Leave</option>
                            <option value="HL">Half Leave</option>
                        </select>
                        
                        <select id="employee-filter" onchange="handleEmployeeFilterChange()">
                            <option value="">All Employees</option>
                        </select>
                        
                        <button onclick="exportData()" class="export-btn">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                    

                    <!-- Data Update Note -->
                    <div id="data-update-note" class="data-update-note" style="display: none;">
                        <i class="fas fa-info-circle"></i>
                        <span id="update-note-text">Your remaining attendance will be updated shortly.</span>
                    </div>

                    <!-- Admin Late Statistics Compact Section -->
                    <div class="admin-late-statistics-compact">
                        <div class="admin-late-compact-header" onclick="toggleLateStatisticsModal()">
                            <div class="admin-late-compact-title">
                                <i class="fas fa-clock"></i>
                                <h3>Employee Late Arrival Statistics</h3>
                            </div>
                            <div class="admin-late-compact-summary">
                                <span class="admin-late-compact-stat">
                                    <strong id="admin-total-late-count">--</strong> Late Arrivals
                                </span>
                                <span class="admin-late-compact-stat">
                                    <strong id="admin-total-late-minutes">--</strong> Total Minutes
                                </span>
                                <span class="admin-late-compact-stat">
                                    <strong id="admin-late-employees">--</strong> Employees
                                </span>
                            </div>
                            <i class="fas fa-chevron-right admin-late-expand-icon"></i>
                        </div>
                    </div>

                    <div id="attendance-table-container" class="table-container">
                        <div class="no-data">
                            <i class="fas fa-inbox"></i>
                            <h3>No Data Available</h3>
                            <p>Upload an Excel file to get started</p>
                        </div>
                    </div>
                </div>

                <!-- Employee Panel -->
                <div id="employee-panel" style="display: none;">
                    <div class="dashboard-header">
                        <div class="header-content">
                            <div class="header-text">
                                <h1><i class="fas fa-user"></i> Welcome, <span id="employee-name"></span>!</h1>
                                <p>Your Personal Attendance Dashboard</p>
                            </div>
                            
                            <!-- Very Visible Test Message -->
                            <div style="background: red !important; color: white !important; font-size: 24px !important; padding: 20px !important; margin: 20px 0 !important; border: 3px solid yellow !important;">
                                🚨 NOTE: Your remaining attendance will be update shortly. 🚨
                            </div>
                            <div class="zoom-controls">
                                <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">
                                    <i class="fas fa-search-minus"></i>
                                </button>
                                <span class="zoom-level" id="zoom-level-employee">100%</span>
                                <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                                <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom">
                                    <i class="fas fa-undo"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="employee-stats">
                        <div class="metric-card metric-present">
                            <i class="fas fa-percentage"></i>
                            <div class="metric-content">
                                <h3 id="attendance-rate">--</h3>
                                <p>Attendance Rate</p>
                            </div>
                        </div>
                        <div class="metric-card metric-total">
                            <i class="fas fa-calendar-day"></i>
                            <div class="metric-content">
                                <h3 id="present-days">--</h3>
                                <p>Present Days</p>
                            </div>
                        </div>
                        <div class="metric-card metric-unpaid">
                            <i class="fas fa-times-circle"></i>
                            <div class="metric-content">
                                <h3 id="unpaid-days">--</h3>
                                <p>Unpaid Days</p>
                            </div>
                        </div>
                        <div class="metric-card metric-total">
                            <i class="fas fa-rupee-sign"></i>
                            <div class="metric-content">
                                <h3 id="payable-days">--</h3>
                                <p>Payable Days</p>
                            </div>
                        </div>
                        <div class="metric-card metric-leave">
                            <i class="fas fa-chart-line"></i>
                            <div class="metric-content">
                                <h3 id="performance-status">--</h3>
                                <p>Performance</p>
                            </div>
                        </div>
                    </div>


                    <!-- Late Statistics Section -->
                    <div class="late-statistics-section">
                        <h3><i class="fas fa-clock"></i> Late Arrival Statistics</h3>
                        <div class="late-stats-grid">
                            <div class="late-stat-card">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div class="late-stat-content">
                                    <h4 id="late-count">--</h4>
                                    <p>Times Late</p>
                                </div>
                            </div>
                            <div class="late-stat-card">
                                <i class="fas fa-hourglass-half"></i>
                                <div class="late-stat-content">
                                    <h4 id="total-late-minutes">--</h4>
                                    <p>Total Late Minutes</p>
                                </div>
                            </div>
                            <div class="late-stat-card">
                                <i class="fas fa-clock"></i>
                                <div class="late-stat-content">
                                    <h4 id="start-time">--</h4>
                                    <p>Expected Start Time</p>
                                </div>
                            </div>
                        </div>
                        <div id="late-records-list" class="late-records-list" style="display: none;">
                            <h4>Late Arrival Records</h4>
                            <div id="late-records-content"></div>
                        </div>
                    </div>

                    <div class="employee-filters">
                        <select id="employee-status-filter" onchange="applyEmployeeFilters()">
                            <option value="All">All Statuses</option>
                            <option value="P">Present</option>
                            <option value="A">Absent</option>
                            <option value="W/O">Week Off</option>
                            <option value="PL">Paid Leave</option>
                            <option value="SL">Sick Leave</option>
                            <option value="FL">Festival Leave</option>
                            <option value="HL">Half Leave</option>
                        </select>
                        <button onclick="exportEmployeeData()" class="export-btn">
                            <i class="fas fa-download"></i> Export My Data
                        </button>
                    </div>

                    <!-- Data Update Note for Employee -->
                    <div id="employee-data-update-note" class="data-update-note" style="display: flex; background: red !important; color: white !important; font-size: 20px !important; padding: 20px !important; margin: 20px 0 !important;">
                        <i class="fas fa-info-circle"></i>
                        <span id="employee-update-note-text">NOTE: Your remaining attendance will be update shortly.</span>
                    </div>

                    <div id="employee-attendance-table" class="table-container">
                        <div class="no-data">
                            <i class="fas fa-user-clock"></i>
                            <h3>No Personal Records Found</h3>
                            <p>Your attendance records are not available in the current dataset.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loading-text">Processing...</p>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-key"></i> Change Password</h3>
                <p class="modal-subtitle">Secure password change with email verification</p>
                <button class="modal-close" onclick="closePasswordChangeDialog()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Email Input (for first time users) -->
                <div id="email-input-step" class="password-step">
                    <div class="step-indicator">
                        <span class="step-number">1</span>
                        <span class="step-text">Enter Company Email</span>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="actual-email-input" placeholder="Enter your company email address" required>
                    </div>
                    <div class="email-note">
                        <small><i class="fas fa-info-circle"></i> We'll send an OTP to this email for verification</small>
                    </div>
                </div>

                <!-- Step 2: Email Display (for returning users) -->
                <div id="email-display-step" class="password-step" style="display: none;">
                    <div class="step-indicator">
                        <span class="step-number">1</span>
                        <span class="step-text">Verify Email</span>
                    </div>
                    <div class="email-display">
                        <i class="fas fa-envelope"></i>
                        <span id="stored-email-display"></span>
                    </div>
                    <div class="email-note">
                        <small><i class="fas fa-info-circle"></i> We'll send an OTP to this email</small>
                    </div>
                </div>

                <!-- Step 3: OTP Input -->
                <div id="otp-input-step" class="password-step" style="display: none;">
                    <div class="step-indicator">
                        <span class="step-number">2</span>
                        <span class="step-text">Enter OTP</span>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-shield-alt"></i>
                        <input type="text" id="otp-input" placeholder="Enter 6-digit OTP" maxlength="6" required>
                    </div>
                    <div class="otp-info">
                        <small><i class="fas fa-clock"></i> OTP sent to <span id="otp-email-display"></span></small>
                        <button onclick="resendOTP()" class="resend-btn">Resend OTP</button>
                    </div>
                </div>

                <!-- Step 4: New Password -->
                <div id="new-password-step" class="password-step" style="display: none;">
                    <div class="step-indicator">
                        <span class="step-number">3</span>
                        <span class="step-text">Set New Password</span>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="new-password-input" placeholder="Enter new password" required>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="confirm-password-input" placeholder="Confirm new password" required>
                    </div>
                    <div class="password-requirements">
                        <small>Password must be at least 6 characters long</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="password-modal-btn" onclick="handlePasswordChangeStep()" class="btn-primary">
                    <i class="fas fa-check"></i> Send OTP
                </button>
                <button onclick="skipPasswordChange()" class="btn-secondary">
                    <i class="fas fa-times"></i> Skip for Now
                </button>
            </div>
        </div>
    </div>

    <!-- Current Password Modal -->


    <!-- Login Logs Modal -->
    <div id="logs-modal" class="modal" style="display: none;">
        <div class="modal-content logs-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-list-alt"></i> Login Logs</h3>
                <button class="modal-close" onclick="closeLogsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="logs-container">
                    <div class="logs-header">
                        <h4>Date-wise Login History</h4>
                        <button onclick="refreshLogs()" class="btn-refresh">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div id="logs-list" class="logs-list">
                        <!-- Logs will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Late Statistics Modal -->
    <div id="late-statistics-modal" class="late-statistics-modal" style="display: none;">
        <div class="late-statistics-modal-content">
            <div class="late-statistics-modal-header">
                <h2><i class="fas fa-clock"></i> Employee Late Arrival Statistics</h2>
                <button class="late-statistics-close-btn" onclick="closeLateStatisticsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="late-statistics-modal-body">
                <div class="admin-late-stats-summary">
                    <div class="admin-late-summary-card">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="admin-late-summary-content">
                            <h4 id="modal-total-late-count">--</h4>
                            <p>Total Late Arrivals</p>
                        </div>
                    </div>
                    <div class="admin-late-summary-card">
                        <i class="fas fa-hourglass-half"></i>
                        <div class="admin-late-summary-content">
                            <h4 id="modal-total-late-minutes">--</h4>
                            <p>Total Late Minutes</p>
                        </div>
                    </div>
                    <div class="admin-late-summary-card">
                        <i class="fas fa-users"></i>
                        <div class="admin-late-summary-content">
                            <h4 id="modal-late-employees">--</h4>
                            <p>Employees with Late Arrivals</p>
                        </div>
                    </div>
                </div>
                <div id="modal-late-employees-list" class="admin-late-employees-list">
                    <h4>Late Arrival Details by Employee</h4>
                    <div id="modal-late-employees-content"></div>
                </div>
            </div>
        </div>
    </div>


    <script src="{{ url_for('static', filename='js/app.js') }}?v={{ range(1000, 9999) | random }}"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
        
        // PWA Install Prompt - No install button, let browser handle it
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // No install button - users can install via browser menu
            console.log('PWA install prompt available - users can install via browser menu');
        });
        
        // Handle successful PWA installation
        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA was installed');
        });
        
        // Real-time Maintenance Mode Checker
        let maintenanceCheckInterval;
        
        function checkMaintenanceStatus() {
            fetch('/api/maintenance/status')
                .then(response => response.json())
                .then(data => {
                    const statusIndicator = document.getElementById('maintenance-status');
                    
                    if (data.enabled) {
                        // Show maintenance indicator
                        if (statusIndicator) {
                            statusIndicator.style.display = 'flex';
                        }
                        
                        // Redirect to maintenance page if not already there
                        if (!window.location.pathname.includes('/admin/maintenance') && 
                            !window.location.pathname.includes('/maintenance')) {
                            console.log('Maintenance mode detected, redirecting...');
                            window.location.href = '/maintenance';
                        }
                    } else {
                        // Hide maintenance indicator
                        if (statusIndicator) {
                            statusIndicator.style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.log('Maintenance check failed:', error);
                });
        }
        
        // Start checking maintenance status every 3 seconds
        function startMaintenanceChecker() {
            if (maintenanceCheckInterval) {
                clearInterval(maintenanceCheckInterval);
            }
            maintenanceCheckInterval = setInterval(checkMaintenanceStatus, 3000);
        }
        
        // Stop checking when page is hidden (user switched tabs)
        function stopMaintenanceChecker() {
            if (maintenanceCheckInterval) {
                clearInterval(maintenanceCheckInterval);
                maintenanceCheckInterval = null;
            }
        }
        
        // Start checking when page becomes visible
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopMaintenanceChecker();
            } else {
                startMaintenanceChecker();
            }
        });
        
        // Start checking immediately
        startMaintenanceChecker();
        
        // Clear Browser Cache Function
        async function clearBrowserCache() {
            try {
                const response = await fetch('/api/clear-cache', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Server returned non-JSON response. Please check server status.');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    showNotification('✅ Cache cleared successfully! Page will reload to apply changes.', 'success');
                    
                    // Reload page after a short delay
                    setTimeout(() => {
                        window.location.reload(true); // Force reload from server
                    }, 2000);
                } else {
                    showNotification('❌ Failed to clear cache: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error clearing cache:', error);
                if (error.message.includes('Unexpected token')) {
                    showNotification('❌ Server error: Invalid response format. Please try again.', 'error');
                } else {
                    showNotification('❌ Error clearing cache: ' + error.message, 'error');
                }
            }
        }
        
        // Show notification function
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-message">${message}</span>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Employee Data Modal Functions
        async function showEmployeeData(employeeName) {
            try {
                const response = await fetch(`/api/employee-data/${encodeURIComponent(employeeName)}`);
                const result = await response.json();
                
                if (result.success) {
                    displayEmployeeData(result.data);
                    document.getElementById('employee-data-modal').style.display = 'flex';
                } else {
                    showNotification('❌ Failed to load employee data: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error loading employee data:', error);
                showNotification('❌ Error loading employee data: ' + error.message, 'error');
            }
        }
        
        function displayEmployeeData(data) {
            const content = document.getElementById('employee-data-content');
            
            content.innerHTML = `
                <div class="employee-data-container">
                    <!-- Employee Info Section -->
                    <div class="employee-info-section">
                        <div class="employee-header">
                            <div class="employee-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="employee-details">
                                <h4>${data.employee_name}</h4>
                                <p class="employee-email">${data.email}</p>
                                <div class="employee-badges">
                                    ${data.is_t_employee ? '<span class="badge badge-t">T Employee</span>' : ''}
                                    ${data.has_changed_password ? '<span class="badge badge-password">Password Changed</span>' : '<span class="badge badge-default">Default Password</span>'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Password Info -->
                        <div class="password-info">
                            <label>Current Password:</label>
                            <div class="password-display">
                                <input type="text" value="${data.password}" readonly>
                                <button onclick="copyPassword('${data.password}')" class="copy-btn">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistics Section -->
                    <div class="statistics-section">
                        <h5><i class="fas fa-chart-bar"></i> Attendance Statistics</h5>
                        <div class="stats-grid">
                            <div class="stat-card stat-total">
                                <div class="stat-number">${data.statistics.total_days}</div>
                                <div class="stat-label">Total Days</div>
                            </div>
                            <div class="stat-card stat-present">
                                <div class="stat-number">${data.statistics.present_days}</div>
                                <div class="stat-label">Present</div>
                            </div>
                            <div class="stat-card stat-unpaid">
                                <div class="stat-number">${data.statistics.unpaid_days}</div>
                                <div class="stat-label">Unpaid</div>
                            </div>
                            <div class="stat-card stat-late">
                                <div class="stat-number">${data.statistics.late_days}</div>
                                <div class="stat-label">Late</div>
                            </div>
                        </div>
                        <div class="attendance-percentage">
                            <div class="percentage-bar">
                                <div class="percentage-fill" style="width: ${data.statistics.attendance_percentage}%"></div>
                            </div>
                            <span class="percentage-text">${data.statistics.attendance_percentage}% Attendance</span>
                        </div>
                    </div>
                    
                    
                    <!-- Recent Records -->
                    <div class="recent-records-section">
                        <h5><i class="fas fa-history"></i> Recent Attendance Records</h5>
                        <div class="records-table">
                            <div class="record-header">
                                <span>Date</span>
                                <span>Punch In</span>
                                <span>Punch Out</span>
                                <span>Status</span>
                            </div>
                            ${data.recent_records.map(record => `
                                <div class="record-row ${getStatusClass(record.Status)}">
                                    <span>${formatDate(record.Date)}</span>
                                    <span>${record['Punch-In'] || '-'}</span>
                                    <span>${record['Punch-Out'] || '-'}</span>
                                    <span class="status-badge">${record.Status}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function closeEmployeeDataModal() {
            document.getElementById('employee-data-modal').style.display = 'none';
        }
        
        function copyPassword(password) {
            navigator.clipboard.writeText(password).then(() => {
                showNotification('✅ Password copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('❌ Failed to copy password', 'error');
            });
        }
        
        function getStatusClass(status) {
            if (status === 'Present') return 'status-present';
            if (status === 'Absent') return 'status-absent';
            if (status.includes('Late')) return 'status-late';
            return '';
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                weekday: 'short',
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }
        
        // Show Employee Data Modal with name input
        function showEmployeeDataModal() {
            const employeeName = prompt('Enter employee name to view data:');
            if (employeeName && employeeName.trim()) {
                showEmployeeData(employeeName.trim());
            }
        }
    </script>

    <!-- Employee Data Modal -->
    <div id="employee-data-modal" class="modal" style="display: none;">
        <div class="modal-content employee-data-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user"></i> Employee Data</h3>
                <button class="modal-close" onclick="closeEmployeeDataModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="employee-data-content">
                    <!-- Employee data will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>
